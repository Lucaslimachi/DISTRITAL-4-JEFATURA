<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Partes de Novedades</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ver_novedades.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="view-novedades-container">
        <h1>Partes de Novedades Registrados</h1>

        <div class="filters-container">
            <div class="filter-group">
                <label for="filterDate">Seleccionar Día:</label>
                <input type="date" id="filterDate">
            </div>
            <div class="filter-group">
                <label for="filterStartTime">Hora Inicio:</label>
                <input type="time" id="filterStartTime">
            </div>
            <div class="filter-group">
                <label for="filterEndTime">Hora Fin:</label>
                <input type="time" id="filterEndTime">
            </div>
            <div class="filter-group">
                <label for="filterTipoDependencia">Tipo de Dependencia:</label>
                <select id="filterTipoDependencia">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterImputado">Nombre del Imputado:</label>
                <input type="text" id="filterImputado" placeholder="Filtrar por nombre del imputado">
            </div>
            <div class="filter-group">
                <label for="filterVictima">Nombre de la Victima:</label>
                <input type="text" id="filterVictima" placeholder="Filtrar por nombre de la victima">
            </div>
            <button id="applyFiltersBtn">Filtrar</button>
            <button id="clearFiltersBtn">Limpiar Filtros</button>
            <button id="downloadPdfBtn">Descargar PDF</button>
            <button id="downloadExcelBtn">Descargar Excel</button>
        </div>

        <div id="novedadesList"></div>
        <button onclick="window.history.back()">Volver a la página anterior</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001'; // Define the API base URL
        let allNovedades = []; // Variable global para almacenar todas las novedades

        document.addEventListener('DOMContentLoaded', function() {
            // const novedades = JSON.parse(localStorage.getItem('novedades')) || []; // REMOVED
            const novedadesListDiv = document.getElementById('novedadesList');

            const filterDateInput = document.getElementById('filterDate');
            const filterStartTimeInput = document.getElementById('filterStartTime');
            const filterEndTimeInput = document.getElementById('filterEndTime');
            const filterTipoDependenciaSelect = document.getElementById('filterTipoDependencia');
            const filterImputadoInput = document.getElementById('filterImputado');
            const filterVictimaInput = document.getElementById('filterVictima');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const downloadExcelBtn = document.getElementById('downloadExcelBtn');

            // let currentNovedadesToRender = []; // Variable para almacenar las novedades actuales renderizadas

            const userRole = localStorage.getItem('userRole'); // Obtener el rol del usuario

            // Fetch novedades from API
            function fetchNovedades() {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    alert('No estás autenticado. Por favor, inicia sesión.');
                    window.location.href = 'index.html';
                    return;
                }

                fetch(`${API_BASE_URL}/novedades`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'Error al cargar las novedades.');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    allNovedades = data; // Store fetched data globally
                    populateFilters(allNovedades);
                    renderNovedades(allNovedades); // Render all initially
                })
                .catch(error => {
                    console.error('Error al obtener novedades:', error);
                    alert(`Error: ${error.message}`);
                });
            }

            // Initial fetch when DOM is loaded
            fetchNovedades();

            function renderNovedades(novedadesToRender) {
                // currentNovedadesToRender = novedadesToRender; // REMOVED
                novedadesListDiv.innerHTML = ''; // Limpiar la lista actual

                if (novedadesToRender.length === 0) {
                    novedadesListDiv.innerHTML = '<p>No hay partes de novedades para mostrar con los filtros aplicados.</p>';
                    return;
                }

                const groupedNovedades = {};
                novedadesToRender.forEach(novedad => {
                    const fecha = novedad.fechaCarga; // Cambiado de novedad.fecha a novedad.fechaCarga
                    const hora = novedad.horaCarga;

                    if (!groupedNovedades[fecha]) {
                        groupedNovedades[fecha] = {};
                    }
                    if (!groupedNovedades[fecha][hora]) {
                        groupedNovedades[fecha][hora] = [];
                    }
                    groupedNovedades[fecha][hora].push(novedad);
                });

                const sortedFechas = Object.keys(groupedNovedades).sort().reverse();

                sortedFechas.forEach(fecha => {
                    const dateSection = document.createElement('div');
                    dateSection.classList.add('date-section');
                    // Eliminado el título de Fecha
                    // dateSection.innerHTML = `<h2>Fecha: ${fecha}</h2>`;
                    novedadesListDiv.appendChild(dateSection);

                    const sortedHoras = Object.keys(groupedNovedades[fecha]).sort().reverse(); // Añadido .reverse()

                    sortedHoras.forEach(hora => {
                        const timeSection = document.createElement('div');
                        timeSection.classList.add('time-section');
                        // Eliminado el título de Hora
                        // timeSection.innerHTML = `<h3>Hora: ${hora}</h3>`;
                        dateSection.appendChild(timeSection);

                        groupedNovedades[fecha][hora].forEach(novedad => {
                            const novedadCard = document.createElement('div');
                            novedadCard.classList.add('novedad-card');
                            let cardContent = '';

                            // Mostrar la Fecha de Carga y Hora de Carga al principio de cada tarjeta
                            cardContent += `<p><strong>FECHA DE CARGA:</strong> ${novedad.fechaCarga || 'N/A'}</p>`;
                            cardContent += `<p><strong>HORA DE CARGA:</strong> ${novedad.horaCarga || 'N/A'}</p>`;

                            // Mostrar la Fecha del Hecho y Hora del Hecho después
                            cardContent += `<p><strong>FECHA DEL HECHO:</strong> ${novedad.fecha || 'N/A'}</p>`;
                            cardContent += `<p><strong>HORA DEL HECHO:</strong> ${novedad.horaDelHecho || 'N/A'}</p>`;

                            for (const key in novedad) {
                                if (novedad.hasOwnProperty(key)) {
                                    // Omitir propiedades que ya se muestran explícitamente
                                    if (key === 'fecha' || key === 'horaDelHecho' || key === 'horaCarga' || key === 'fechaCarga') {
                                        continue;
                                    }
                                    let displayKey = key.replace(/([A-Z])/g, ' $1').toUpperCase();
                                    if (key === 'latitud' || key === 'longitud') {
                                        displayKey = key.toUpperCase(); // Mantener LATITUD y LONGITUD
                                    } else if (key === 'esclarecidos') {
                                        displayKey = 'SITUACION DEL IMPUTADO'; // Cambiado de 'DATOS DEL IMPUTADO'
                                    }
                                    let displayValue = novedad[key];
                                    if (key === 'departamento' || key === 'dependencia' || key === 'victima' || key === 'esclarecidos') {
                                        displayValue = String(novedad[key]).toUpperCase();
                                    } else if (key === 'nombreImputado') { // Aplicar mayúsculas y color rojo al nombre del imputado
                                        displayKey = 'NOMBRE DEL IMPUTADO';
                                        displayValue = `<span style="color: red;">${String(novedad[key]).toUpperCase()}</span>`;
                                    }
                                    else if (key === 'victima') {
                                        displayKey = 'NOMBRE DE LA VICTIMA';
                                        displayValue = `<span style="color: blue;">${String(novedad[key]).toUpperCase()}</span>`;
                                    }
                                    cardContent += `<p><strong>${displayKey}:</strong> ${displayValue}</p>`;
                                }
                            }
                            novedadCard.innerHTML = cardContent;

                            if (userRole === 'admin') {
                                const editButton = document.createElement('button');
                                editButton.textContent = 'Editar';
                                editButton.classList.add('edit-btn');
                                editButton.onclick = () => editNovedad(novedad.id);
                                novedadCard.appendChild(editButton);

                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Eliminar';
                                deleteButton.classList.add('delete-btn');
                                deleteButton.onclick = () => deleteNovedad(novedad.id);
                                novedadCard.appendChild(deleteButton);
                            }

                            timeSection.appendChild(novedadCard);
                        });
                    });
                });
            }

            // Función para popular las opciones de los filtros
            function populateFilters(novedadesData) {
                const tiposDependencia = new Set();

                novedadesData.forEach(novedad => {
                    if (novedad.dependencia) {
                        // Extraer el tipo de dependencia, por ejemplo, 'COMISARIA' o 'SUBCOMISARIA'
                        const tipo = novedad.dependencia.split(' ')[0];
                        tiposDependencia.add(tipo);
                    }
                });

                // Llenar select de Tipo de Dependencia
                filterTipoDependenciaSelect.innerHTML = '<option value="">Todos</option>'; // Resetear
                tiposDependencia.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo.toUpperCase();
                    filterTipoDependenciaSelect.appendChild(option);
                });
            }

            // Inicializar al cargar la página
            // populateFilters(novedades); // REMOVED
            // renderNovedades(novedades); // REMOVED

            applyFiltersBtn.addEventListener('click', function() {
                const filterDate = filterDateInput.value;
                const filterStartTime = filterStartTimeInput.value;
                const filterEndTime = filterEndTimeInput.value;
                const selectedTipoDependencia = filterTipoDependenciaSelect.value;
                const filterImputado = filterImputadoInput.value.toLowerCase(); // Obtener valor y convertir a minúsculas
                const filterVictima = filterVictimaInput.value.toLowerCase(); // Obtener valor y convertir a minúsculas

                let filtered = [...allNovedades]; // Use allNovedades from global scope

                if (filterDate) {
                    filtered = filtered.filter(novedad => novedad.fecha === filterDate);
                }

                if (filterStartTime && filterEndTime) {
                    filtered = filtered.filter(novedad => {
                        const novedadTime = novedad.horaCarga;
                        return novedadTime >= filterStartTime && novedadTime <= filterEndTime;
                    });
                } else if (filterStartTime) {
                    filtered = filtered.filter(novedad => novedad.horaCarga >= filterStartTime);
                } else if (filterEndTime) {
                    filtered = filtered.filter(novedad => novedad.horaCarga <= filterEndTime);
                }

                if (selectedTipoDependencia) {
                    filtered = filtered.filter(novedad => {
                        return novedad.dependencia && novedad.dependencia.startsWith(selectedTipoDependencia);
                    });
                }

                // Nuevo filtro para Nombre del Imputado
                if (filterImputado) {
                    filtered = filtered.filter(novedad => {
                        return novedad.nombreImputado && String(novedad.nombreImputado).toLowerCase().includes(filterImputado);
                    });
                }

                // Nuevo filtro para Nombre de la Victima
                if (filterVictima) {
                    filtered = filtered.filter(novedad => {
                        return novedad.victima && String(novedad.victima).toLowerCase().includes(filterVictima);
                    });
                }

                renderNovedades(filtered);
            });

            clearFiltersBtn.addEventListener('click', function() {
                filterDateInput.value = '';
                filterStartTimeInput.value = '';
                filterEndTimeInput.value = '';
                filterTipoDependenciaSelect.value = '';
                filterImputadoInput.value = ''; // Limpiar el nuevo filtro
                filterVictimaInput.value = ''; // Limpiar el nuevo filtro
                renderNovedades(allNovedades); // Render all novedades when filters are cleared
            });

            downloadPdfBtn.addEventListener('click', function() {
                const element = document.getElementById('novedadesList');
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                const filename = `PARTE DE NOVEDADES_${dateString}.pdf`;
                html2pdf().from(element).save(filename);
            });

            downloadExcelBtn.addEventListener('click', function() {
                const today = new Date();
                const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                const filename = `PARTE DE NOVEDADES_${dateString}`;
                exportToExcel(allNovedades, filename); // Use allNovedades from global scope
            });

            function exportToExcel(data, filename) {
                if (data.length === 0) {
                    alert('No hay datos para exportar a Excel.');
                    return;
                }

                // Crear un array de arrays para la hoja de cálculo
                const wsData = [];

                // Añadir encabezados de columna
                // Asumiendo que todas las novedades tienen las mismas claves
                const headers = Object.keys(data[0]).map(key => {
                    let displayKey = key.replace(/([A-Z])/g, ' $1').toUpperCase();
                    if (key === 'latitud' || key === 'longitud') {
                        displayKey = key.toUpperCase();
                    } else if (key === 'esclarecidos') {
                        displayKey = 'DATOS DEL IMPUTADO';
                    }
                    return displayKey;
                });
                wsData.push(headers);

                // Añadir los datos
                data.forEach(novedad => {
                    const row = Object.values(novedad).map(value => {
                        if (typeof value === 'string') {
                            return value.toUpperCase();
                        }
                        return value;
                    });
                    wsData.push(row);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Novedades');

                // Guardar el archivo Excel
                XLSX.writeFile(wb, `${filename}.xlsx`);
            }

            // Event listener para el nuevo botón de eliminar todas las novedades
            // if (clearAllNovedadesBtn) {
            //     clearAllNovedadesBtn.addEventListener('click', function() {
            //         if (confirm('¿Estás seguro de que quieres eliminar TODOS los partes de novedades? Esta acción no se puede deshacer.')) {
            //             localStorage.removeItem('novedades');
            //             alert('Todas las novedades han sido eliminadas.');
            //             location.reload(); // Recargar la página para reflejar los cambios
            //         }
            //     });
            // }

            function deleteNovedad(id) {
                if (confirm('¿Estás seguro de que quieres eliminar esta novedad? Esta acción no se puede deshacer.')) {
                    const token = localStorage.getItem('jwtToken');
                    if (!token) {
                        alert('No estás autenticado. Por favor, inicia sesión.');
                        window.location.href = 'index.html';
                        return;
                    }
                    fetch(`${API_BASE_URL}/novedades/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.message || 'Error al eliminar la novedad.');
                            });
                        }
                        alert('Novedad eliminada exitosamente.');
                        fetchNovedades(); // Refresh the list after deletion
                    })
                    .catch(error => {
                        console.error('Error al eliminar novedad:', error);
                        alert(`Error: ${error.message}`);
                    });
                }
            }

            function editNovedad(id) {
                // Redirigir a novedades_parte.html con el ID de la novedad
                window.location.href = `novedades_parte.html?id=${id}`;
            }

        });
    </script>
</body>
</html>