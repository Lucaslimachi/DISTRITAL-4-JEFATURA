<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Partes de Novedades</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ver_novedades.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="view-novedades-container">
        <h1>Partes de Novedades Registrados</h1>

        <div class="filters-container">
            <div class="filter-group">
                <label for="filterDate">Seleccionar Día:</label>
                <input type="date" id="filterDate">
            </div>
            <div class="filter-group">
                <label for="filterStartTime">Hora Inicio:</label>
                <input type="time" id="filterStartTime">
            </div>
            <div class="filter-group">
                <label for="filterEndTime">Hora Fin:</label>
                <input type="time" id="filterEndTime">
            </div>
            <div class="filter-group">
                <label for="filterTipoDependencia">Tipo de Dependencia:</label>
                <select id="filterTipoDependencia">
                    <option value="">Todos</option>
                </select>
            </div>
            <button id="applyFiltersBtn">Filtrar</button>
            <button id="clearFiltersBtn">Limpiar Filtros</button>
            <button id="downloadPdfBtn">Descargar PDF</button>
        </div>

        <div id="novedadesList"></div>
        <button onclick="window.history.back()">Volver a la página anterior</button>
    </div>

    <script>
        const API_BASE_URL = 'https://distrital-4-jefatura.onrender.com'; // Define the API base URL
        let allNovedades = []; // Variable global para almacenar todas las novedades
        const novedadesListDiv = document.getElementById('novedadesList');

        const filterDateInput = document.getElementById('filterDate');
        const filterStartTimeInput = document.getElementById('filterStartTime');
        const filterEndTimeInput = document.getElementById('filterEndTime');
        const filterTipoDependenciaSelect = document.getElementById('filterTipoDependencia');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        const userRole = localStorage.getItem('userRole'); // Obtener el rol del usuario

        // Fetch novedades from API
        function fetchNovedades() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('No estás autenticado. Por favor, inicia sesión.');
                window.location.href = 'index.html';
                return;
            }

            fetch(`${API_BASE_URL}/novedades`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Error al cargar las novedades.');
                    });
                }
                return response.json();
            })
            .then(data => {
                allNovedades = data; // Store fetched data globally
                populateFilters(allNovedades);
                renderNovedades(allNovedades); // Render all initially
            })
            .catch(error => {
                console.error('Error al obtener novedades:', error);
                alert(`Error: ${error.message}`);
            });
        }

        function renderNovedades(novedadesToRender) {
            novedadesListDiv.innerHTML = ''; // Limpiar la lista actual

            if (novedadesToRender.length === 0) {
                novedadesListDiv.innerHTML = '<p>No hay partes de novedades para mostrar con los filtros aplicados.</p>';
                return;
            }

            const groupedNovedades = {};
            novedadesToRender.forEach(novedad => {
                // Usar fechaDelHecho para agrupar, o fechaCarga si fechaDelHecho no está disponible
                const fecha = novedad.fechaDelHecho || novedad.fechaCarga;
                const hora = novedad.horaDelHecho || novedad.horaCarga; // Usar horaDelHecho si existe, sino horaCarga

                if (!groupedNovedades[fecha]) {
                    groupedNovedades[fecha] = {};
                }
                if (!groupedNovedades[fecha][hora]) {
                    groupedNovedades[fecha][hora] = [];
                }
                groupedNovedades[fecha][hora].push(novedad);
            });

            const sortedFechas = Object.keys(groupedNovedades).sort().reverse();

            sortedFechas.forEach(fecha => {
                const dateSection = document.createElement('div');
                dateSection.classList.add('date-section');
                dateSection.innerHTML = `<h2>Fecha: ${fecha}</h2>`;
                novedadesListDiv.appendChild(dateSection);

                const sortedHoras = Object.keys(groupedNovedades[fecha]).sort();

                sortedHoras.forEach(hora => {
                    const timeSection = document.createElement('div');
                    timeSection.classList.add('time-section');
                    timeSection.innerHTML = `<h3>Hora: ${hora}</h3>`;
                    dateSection.appendChild(timeSection);

                    groupedNovedades[fecha][hora].forEach(novedad => {
                        const novedadCard = document.createElement('div');
                        novedadCard.classList.add('novedad-card');
                        let cardContent = '';

                        cardContent += `<p><strong>FECHA DEL HECHO:</strong> ${novedad.fechaDelHecho || 'N/A'}</p>`;
                        cardContent += `<p><strong>HORA DEL HECHO:</strong> ${novedad.horaDelHecho || 'N/A'}</p>`;
                        cardContent += `<p><strong>FECHA DE CARGA:</strong> ${novedad.fechaCarga || 'N/A'}</p>`;
                        cardContent += `<p><strong>HORA DE CARGA:</strong> ${novedad.horaCarga || 'N/A'}</p>`;

                        for (const key in novedad) {
                            if (novedad.hasOwnProperty(key)) {
                                // Omitir propiedades que ya se muestran explícitamente o que no queremos mostrar
                                if (['fechaDelHecho', 'horaDelHecho', 'fechaCarga', 'horaCarga', 'id', 'latitud', 'longitud'].includes(key)) {
                                    continue;
                                }

                                let displayKey = key.replace(/([A-Z])/g, ' $1').toUpperCase();
                                let displayValue = novedad[key];

                                if (key === 'coordenadas') {
                                    const [lat, lng] = displayValue.split(',');
                                    displayValue = `Lat: ${parseFloat(lat).toFixed(4)}, Lon: ${parseFloat(lng).toFixed(4)}`;
                                } else if (key === 'esclarecidos') {
                                    displayKey = 'ESTADO/SITUACION';
                                    displayValue = String(novedad[key]).toUpperCase();
                                } else if (key === 'departamento' || key === 'dependencia' || key === 'victima' || key === 'nombreImputado' || key === 'lugar' || key === 'bienAfectado' || key === 'encuadreLegal') {
                                    displayValue = String(novedad[key]).toUpperCase();
                                } else if (key === 'altura' || key === 'entreCalles' || key === 'edadVictima' || key === 'generoVictima' || key === 'observaciones') {
                                    if (!displayValue) continue; // No mostrar si es nulo o vacío
                                }
                                
                                cardContent += `<p><strong>${displayKey}:</strong> ${displayValue}</p>`;
                            }
                        }
                        novedadCard.innerHTML = cardContent;

                        if (userRole === 'admin' || userRole === 'user-oficiales') {
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar';
                            editButton.classList.add('edit-btn');
                            editButton.onclick = () => editNovedad(novedad.id);
                            novedadCard.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Eliminar';
                            deleteButton.classList.add('delete-btn');
                            deleteButton.onclick = () => deleteNovedad(novedad.id);
                            novedadCard.appendChild(deleteButton);
                        }
                        timeSection.appendChild(novedadCard);
                    });
                });
            });
        }

        // Función para popular las opciones de los filtros
        function populateFilters(novedadesData) {
            const tiposDependencia = new Set();
            const dependencias = new Set(); // Para agrupar por dependencia completa si es necesario

            novedadesData.forEach(novedad => {
                if (novedad.dependencia) {
                    // Extraer el tipo de dependencia, por ejemplo, 'COMISARIA' o 'SUBCOMISARIA'
                    const tipo = novedad.dependencia.split(' ')[0];
                    tiposDependencia.add(tipo);
                    dependencias.add(novedad.dependencia);
                }
            });

            // Llenar select de Tipo de Dependencia
            filterTipoDependenciaSelect.innerHTML = '<option value="">Todos</option>'; // Resetear
            tiposDependencia.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo.toUpperCase();
                filterTipoDependenciaSelect.appendChild(option);
            });
            // Opcional: si quieres un filtro para cada dependencia específica, puedes añadir otro select
            // por ejemplo, para 'Comisaría 15', 'Comisaría 18', etc.
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchNovedades(); // Cargar las novedades desde el backend al iniciar la página

            applyFiltersBtn.addEventListener('click', function() {
                const filterDate = filterDateInput.value;
                const filterStartTime = filterStartTimeInput.value;
                const filterEndTime = filterEndTimeInput.value;
                const selectedTipoDependencia = filterTipoDependenciaSelect.value;

                let filtered = [...allNovedades];

                if (filterDate) {
                    filtered = filtered.filter(novedad => (novedad.fechaDelHecho || novedad.fechaCarga) === filterDate);
                }

                if (filterStartTime && filterEndTime) {
                    filtered = filtered.filter(novedad => {
                        const novedadTime = novedad.horaDelHecho || novedad.horaCarga;
                        return novedadTime >= filterStartTime && novedadTime <= filterEndTime;
                    });
                } else if (filterStartTime) {
                    filtered = filtered.filter(novedad => (novedad.horaDelHecho || novedad.horaCarga) >= filterStartTime);
                } else if (filterEndTime) {
                    filtered = filtered.filter(novedad => (novedad.horaDelHecho || novedad.horaCarga) <= filterEndTime);
                }

                if (selectedTipoDependencia) {
                    filtered = filtered.filter(novedad => {
                        return novedad.dependencia && novedad.dependencia.startsWith(selectedTipoDependencia);
                    });
                }

                renderNovedades(filtered);
            });

            clearFiltersBtn.addEventListener('click', function() {
                filterDateInput.value = '';
                filterStartTimeInput.value = '';
                filterEndTimeInput.value = '';
                filterTipoDependenciaSelect.value = ''; // Limpiar el nuevo filtro
                renderNovedades(allNovedades); // Renderizar todas las novedades
            });

            downloadPdfBtn.addEventListener('click', function() {
                const element = document.getElementById('novedadesList');
                html2pdf().from(element).save('partes_de_novedades.pdf');
            });
        });

        function deleteNovedad(id) {
            if (confirm('¿Estás seguro de que quieres eliminar esta novedad? Esta acción no se puede deshacer.')) {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    alert('No estás autenticado. Por favor, inicia sesión.');
                    window.location.href = 'index.html';
                    return;
                }
                fetch(`${API_BASE_URL}/novedades/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || 'Error al eliminar la novedad.');
                        });
                    }
                    alert('Novedad eliminada exitosamente.');
                    fetchNovedades(); // Refresh the list after deletion
                })
                .catch(error => {
                    console.error('Error al eliminar novedad:', error);
                    alert(`Error: ${error.message}`);
                });
            }
        }

        function editNovedad(id) {
            // Redirigir a novedades_parte.html con el ID de la novedad
            window.location.href = `novedades_parte.html?id=${id}`;
        }
    </script>
</body>
</html>